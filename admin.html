<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Amnairi RS Admin</title>
    <link rel="stylesheet" href="./admin.css" />
  </head>
  <body>
    <main class="admin-shell">
      <header class="admin-header">
        <div>
          <h1>Amnairi RS Admin</h1>
          <p class="subtitle">Approve login requests and view service users.</p>
        </div>
      </header>

      <section class="card">
        <form id="admin-key-form" class="form-inline" autocomplete="off">
          <label for="adminKey">Admin Key</label>
          <input type="password" id="adminKey" placeholder="Enter admin key" required />
          <button type="submit">Unlock</button>
        </form>
        <p class="hint">Admin key unlocks pending requests and user lists.</p>
      </section>

      <section class="card" id="requests-card" hidden>
        <header class="card-header">
          <h2>Pending Login Requests</h2>
          <button id="refreshRequests" type="button" class="ghost">Refresh</button>
        </header>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>SU</th>
                <th>TIN</th>
                <th>SP</th>
                <th>Requested</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="requestsTableBody">
              <tr class="empty-state">
                <td colspan="5">No pending login requests.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <section class="card" id="users-card" hidden>
        <header class="card-header">
          <h2>Service Users</h2>
          <button id="refreshUsers" type="button" class="ghost">Refresh</button>
        </header>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Company</th>
                <th>SU</th>
                <th>Status</th>
                <th>Updated</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <tr class="empty-state">
                <td colspan="5">No users yet.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>

    <template id="request-row-template">
      <tr>
        <td class="su"></td>
        <td class="tin"></td>
        <td class="sp"></td>
        <td class="created"></td>
        <td class="row-actions">
          <button type="button" class="approve">Approve</button>
          <button type="button" class="deny ghost">Deny</button>
        </td>
      </tr>
    </template>

    <template id="user-row-template">
      <tr>
        <td class="company"></td>
        <td class="su"></td>
        <td class="status"></td>
        <td class="updated"></td>
        <td class="row-actions">
          <button type="button" class="revoke ghost">Revoke</button>
        </td>
      </tr>
    </template>

    <script>
      const state = { adminKey: "" };

      function setCardVisibility(enabled) {
        document.getElementById("requests-card").hidden = !enabled;
        document.getElementById("users-card").hidden = !enabled;
      }

      function formatDate(ts) {
        if (!ts) return "-";
        const d = new Date(ts);
        if (Number.isNaN(d.getTime())) return ts;
        return d.toLocaleString();
      }

      function showToast(message, type = "info") {
        const toast = document.createElement("div");
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        requestAnimationFrame(() => toast.classList.add("visible"));
        setTimeout(() => {
          toast.classList.remove("visible");
          toast.addEventListener("transitionend", () => toast.remove(), { once: true });
        }, 2400);
      }

      async function authorizedFetch(url, options = {}) {
        if (!state.adminKey) throw new Error("Admin key is missing");
        const headers = {
          "Content-Type": "application/json",
          "x-admin-key": state.adminKey,
          ...(options.headers || {}),
        };
        const res = await fetch(url, { ...options, headers });
        if (res.status === 401) throw new Error("Invalid admin key");
        return res;
      }

      function renderUsers(users) {
        const tbody = document.getElementById("usersTableBody");
        tbody.innerHTML = "";
        if (!Array.isArray(users) || users.length === 0) {
          const tr = document.createElement("tr");
          tr.className = "empty-state";
          tr.innerHTML = '<td colspan="5">No users yet.</td>';
          tbody.appendChild(tr);
          return;
        }
        const tpl = document.getElementById("user-row-template");
        users.forEach((user) => {
          const frag = tpl.content.cloneNode(true);
          frag.querySelector(".company").textContent = user.company_name || "-";
          frag.querySelector(".su").textContent = user.su;
          const statusEl = frag.querySelector(".status");
          statusEl.textContent = user.status || "-";
          statusEl.className = `status ${
            user.status === "approved" ? "ok" : user.status === "pending" ? "warn" : "err"
          }`;
          frag.querySelector(".updated").textContent = formatDate(user.updated_at || user.created_at);
          const revokeBtn = frag.querySelector(".revoke");
          revokeBtn.dataset.su = user.su;
          revokeBtn.disabled = user.status !== "approved";
          revokeBtn.textContent = user.status === "approved" ? "Revoke" : "Revoked";
          tbody.appendChild(frag);
        });
      }

      function renderRequests(requests) {
        const tbody = document.getElementById("requestsTableBody");
        tbody.innerHTML = "";
        if (!Array.isArray(requests) || requests.length === 0) {
          const tr = document.createElement("tr");
          tr.className = "empty-state";
          tr.innerHTML = '<td colspan="5">No pending login requests.</td>';
          tbody.appendChild(tr);
          return;
        }
        const tpl = document.getElementById("request-row-template");
        requests.forEach((req) => {
          const frag = tpl.content.cloneNode(true);
          frag.querySelector(".su").textContent = req.su;
          frag.querySelector(".tin").textContent = req.tin || "-";
          frag.querySelector(".sp").textContent = req.plain_sp || "-";
          frag.querySelector(".created").textContent = formatDate(req.created_at);
          frag.querySelector(".approve").dataset.id = req.id;
          frag.querySelector(".deny").dataset.id = req.id;
          tbody.appendChild(frag);
        });
      }

      async function loadUsers() {
        try {
          const res = await authorizedFetch("/admin/users");
          const payload = await res.json();
          if (!payload.success) {
            showToast(payload.message || "Failed to load users", "error");
            return;
          }
          renderUsers(payload.users);
        } catch (err) {
          showToast(err.message || "Failed to load users", "error");
          renderUsers([]);
        }
      }

      async function loadRequests() {
        try {
          const res = await authorizedFetch("/admin/login-requests");
          const payload = await res.json();
          if (!payload.success) {
            showToast(payload.message || "Failed to load requests", "error");
            return;
          }
          renderRequests(payload.requests);
        } catch (err) {
          showToast(err.message || "Failed to load requests", "error");
          renderRequests([]);
        }
      }

      async function decideRequest(id, decision) {
        const url =
          decision === "approve"
            ? `/admin/login-requests/${id}/approve`
            : `/admin/login-requests/${id}/deny`;
        try {
          const res = await authorizedFetch(url, { method: "POST", body: JSON.stringify({}) });
          const payload = await res.json();
          if (!payload.success) throw new Error(payload.message || "Action failed");
          showToast(decision === "approve" ? "Approved" : "Denied", decision === "approve" ? "ok" : "warn");
          loadRequests();
          loadUsers();
        } catch (err) {
          showToast(err.message || "Action failed", "error");
        }
      }

      document.getElementById("admin-key-form").addEventListener("submit", (event) => {
        event.preventDefault();
        const key = event.target.adminKey.value.trim();
        if (!key) return;
        state.adminKey = key;
        sessionStorage.setItem("adminKey", key);
        setCardVisibility(true);
        loadUsers();
        loadRequests();
        showToast("Admin mode enabled", "ok");
      });

      document.getElementById("refreshUsers").addEventListener("click", loadUsers);
      document.getElementById("refreshRequests").addEventListener("click", loadRequests);

      document.getElementById("requestsTableBody").addEventListener("click", (event) => {
        if (event.target.classList.contains("approve")) {
          const id = event.target.dataset.id;
          if (id) decideRequest(id, "approve");
        } else if (event.target.classList.contains("deny")) {
          const id = event.target.dataset.id;
          if (id && confirm("Deny this request?")) decideRequest(id, "deny");
        }
      });

      document.getElementById("usersTableBody").addEventListener("click", async (event) => {
        if (!event.target.classList.contains("revoke")) return;
        const su = event.target.dataset.su;
        if (!su) return;
        if (!confirm(`Revoke access for ${su}?`)) return;
        try {
          const res = await authorizedFetch("/admin/revokeUser", {
            method: "POST",
            body: JSON.stringify({ su }),
          });
          const payload = await res.json();
          if (!payload.success) throw new Error(payload.message || "Revoke failed");
          showToast("Revoked", "warn");
          loadUsers();
        } catch (err) {
          showToast(err.message || "Revoke failed", "error");
        }
      });

      window.addEventListener("DOMContentLoaded", () => {
        const saved = sessionStorage.getItem("adminKey");
        if (saved) {
          state.adminKey = saved;
          document.getElementById("adminKey").value = saved;
          setCardVisibility(true);
          loadUsers();
          loadRequests();
          setInterval(() => {
            loadRequests();
            loadUsers();
          }, 15000);
        }
      });
    </script>
  </body>
</html>
