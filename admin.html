<!DOCTYPE html>
<html lang="ka">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Amnairi RS Accounts</title>
    <link rel="stylesheet" href="./admin.css" />
  </head>
  <body>
    <main class="admin-shell">
      <header class="admin-header">
        <div>
          <h1>Amnairi RS Accounts</h1>
          <p class="subtitle">áƒ›áƒáƒ áƒ—áƒ” áƒ«áƒ˜áƒ áƒ˜áƒ—áƒáƒ“áƒ˜ áƒ“áƒ áƒ¥áƒ•áƒ”-áƒáƒœáƒ’áƒáƒ áƒ˜áƒ¨áƒ”áƒ‘áƒ˜ áƒ£áƒ¡áƒáƒ¤áƒ áƒ—áƒ®áƒáƒ“.</p>
        </div>
      </header>

      <section class="card">
        <form id="admin-key-form" class="form-inline" autocomplete="off">
          <label for="adminKey">Admin Key</label>
          <input
            type="password"
            id="adminKey"
            placeholder="áƒ¨áƒ”áƒ˜áƒ§áƒ•áƒáƒœáƒ”áƒ— áƒ¡áƒáƒ˜áƒ“áƒ£áƒ›áƒšáƒ áƒ’áƒáƒ¡áƒáƒ¦áƒ”áƒ‘áƒ˜"
            required
          />
          <button type="submit">áƒ“áƒáƒ“áƒáƒ¡áƒ¢áƒ£áƒ áƒ”áƒ‘áƒ</button>
        </form>
        <p class="hint">
          áƒ’áƒáƒ¡áƒáƒ¦áƒ”áƒ‘áƒ˜ áƒ˜áƒœáƒáƒ®áƒ”áƒ‘áƒ áƒ›áƒ®áƒáƒšáƒáƒ“ áƒáƒ› áƒ‘áƒ áƒáƒ£áƒ–áƒ”áƒ áƒ˜áƒ¡ áƒ¡áƒ”áƒ¡áƒ˜áƒ˜áƒ¡ áƒ’áƒáƒœáƒ›áƒáƒ•áƒšáƒáƒ‘áƒáƒ¨áƒ˜.
        </p>
      </section>

      <section class="card" id="add-user-card" hidden>
        <h2>â• áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ</h2>
        <form id="add-user-form" autocomplete="off">
          <div class="field-row">
            <label for="suInput">áƒ›áƒáƒ›áƒ®áƒ›áƒáƒ áƒ”áƒ‘áƒ”áƒšáƒ˜ (SU)</label>
            <input id="suInput" name="su" maxlength="64" required />
          </div>
          <div class="field-row">
            <label for="spInput">áƒáƒáƒ áƒáƒšáƒ˜ (SP)</label>
            <input
              id="spInput"
              name="sp"
              type="password"
              maxlength="64"
              required
            />
          </div>
          <div class="field-row">
            <label for="labelInput">áƒ™áƒáƒ›áƒáƒáƒœáƒ˜áƒ˜áƒ¡ áƒ“áƒáƒ¡áƒáƒ®áƒ”áƒšáƒ”áƒ‘áƒ</label>
            <input
              id="labelInput"
              name="company_name"
              maxlength="128"
              required
            />
          </div>
          <div class="actions">
            <button type="submit">áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ</button>
          </div>
        </form>
      </section>

      <section class="card" id="users-card" hidden>
        <header class="card-header">
          <h2>ğŸ’¼ áƒáƒœáƒ’áƒáƒ áƒ˜áƒ¨áƒ”áƒ‘áƒ˜</h2>
          <button id="refreshUsers" type="button" class="ghost">
            áƒ’áƒáƒœáƒáƒ®áƒšáƒ”áƒ‘áƒ
          </button>
        </header>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>áƒ™áƒáƒ›áƒáƒáƒœáƒ˜áƒ</th>
                <th>SU</th>
                <th>áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ˜</th>
                <th>áƒ’áƒáƒœáƒáƒ®áƒšáƒ“áƒ</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <tr class="empty-state">
                <td colspan="5">áƒáƒœáƒ’áƒáƒ áƒ˜áƒ¨áƒ”áƒ‘áƒ˜ áƒ¯áƒ”áƒ  áƒáƒ  áƒáƒ áƒ˜áƒ¡ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ£áƒšáƒ˜.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>

    <template id="user-row-template">
      <tr>
        <td class="company"></td>
        <td class="su"></td>
        <td class="status"></td>
        <td class="updated"></td>
        <td class="row-actions">
          <button type="button" class="revoke">áƒ’áƒáƒ—áƒ˜áƒ¨áƒ•áƒ</button>
        </td>
      </tr>
    </template>

    <script>
      const state = {
        adminKey: "",
      };

      function setCardVisibility(enabled) {
        document.getElementById("add-user-card").hidden = !enabled;
        document.getElementById("users-card").hidden = !enabled;
      }

      function formatDate(ts) {
        if (!ts) return "-";
        const date = new Date(ts + "Z");
        if (Number.isNaN(date.getTime())) return ts;
        return date.toLocaleString("ka-GE", {
          year: "numeric",
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function showToast(message, type = "info") {
        const toast = document.createElement("div");
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        requestAnimationFrame(() => toast.classList.add("visible"));
        setTimeout(() => {
          toast.classList.remove("visible");
          toast.addEventListener("transitionend", () => toast.remove(), {
            once: true,
          });
        }, 2400);
      }

      async function authorizedFetch(url, options = {}) {
        if (!state.adminKey) {
          throw new Error("Admin key is missing");
        }
        const headers = {
          "Content-Type": "application/json",
          "x-admin-key": state.adminKey,
          ...(options.headers || {}),
        };
        const response = await fetch(url, {
          ...options,
          headers,
        });

        if (response.status === 401) {
          throw new Error("áƒáƒ áƒáƒ¡áƒ¬áƒáƒ áƒ˜ Admin Key");
        }
        return response;
      }

      function renderUsers(users) {
        const tbody = document.getElementById("usersTableBody");
        tbody.innerHTML = "";
        if (!Array.isArray(users) || users.length === 0) {
          const tr = document.createElement("tr");
          tr.className = "empty-state";
          tr.innerHTML = '<td colspan="5">áƒáƒœáƒ’áƒáƒ áƒ˜áƒ¨áƒ”áƒ‘áƒ˜ áƒáƒ  áƒ›áƒáƒ˜áƒ«áƒ”áƒ‘áƒœáƒ.</td>';
          tbody.appendChild(tr);
          return;
        }

        const template = document.getElementById("user-row-template");
        users.forEach((user) => {
          const fragment = template.content.cloneNode(true);
          fragment.querySelector(".company").textContent =
            user.company_name || "-";
          fragment.querySelector(".su").textContent = user.su;
          const statusEl = fragment.querySelector(".status");
          statusEl.textContent = user.active ? "áƒáƒ¥áƒ¢áƒ˜áƒ£áƒ áƒ˜" : "áƒ’áƒáƒ—áƒ˜áƒ¨áƒ£áƒšáƒ˜";
          statusEl.className = `status ${user.active ? "ok" : "err"}`;
          fragment.querySelector(".updated").textContent = formatDate(
            user.updated_at || user.created_at
          );
          const revokeBtn = fragment.querySelector(".revoke");
          revokeBtn.textContent = user.active ? "áƒ’áƒáƒ—áƒ˜áƒ¨áƒ•áƒ" : "áƒ£áƒ™áƒ•áƒ” áƒ’áƒáƒ—áƒ˜áƒ¨áƒ£áƒšáƒ˜áƒ";
          revokeBtn.disabled = !user.active;
          revokeBtn.dataset.su = user.su;
          tbody.appendChild(fragment);
        });
      }

      async function loadUsers() {
        try {
          const res = await authorizedFetch("/admin/users");
          const payload = await res.json();
          if (!payload.success) {
            showToast(payload.message || "áƒ•áƒ”áƒ  áƒ›áƒ˜áƒ•áƒ˜áƒ¦áƒ”áƒ— áƒ›áƒáƒœáƒáƒªáƒ”áƒ›áƒ”áƒ‘áƒ˜", "error");
            return;
          }
          renderUsers(payload.users);
        } catch (err) {
          showToast(err.message || "áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ", "error");
          renderUsers([]);
        }
      }

      document
        .getElementById("admin-key-form")
        .addEventListener("submit", (event) => {
          event.preventDefault();
          const key = event.target.adminKey.value.trim();
          if (!key) return;
          state.adminKey = key;
          sessionStorage.setItem("adminKey", key);
          setCardVisibility(true);
          loadUsers();
          showToast("áƒáƒ“áƒ›áƒ˜áƒœáƒ˜áƒ¡áƒ¢áƒ áƒáƒ¢áƒáƒ áƒ˜áƒ¡ áƒ’áƒáƒ¡áƒáƒ¦áƒ”áƒ‘áƒ˜ áƒ’áƒáƒœáƒáƒ®áƒšáƒ“áƒ", "ok");
        });

      document
        .getElementById("add-user-form")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          const form = event.target;
          const su = form.su.value.trim();
          const sp = form.sp.value;
          const companyName = form.company_name.value.trim();

          if (!su || !sp || !companyName) return;

          try {
            const res = await authorizedFetch("/admin/addUser", {
              method: "POST",
              body: JSON.stringify({ su, sp, company_name: companyName }),
            });
            const payload = await res.json();
            if (!payload.success) {
              throw new Error(payload.message || "áƒ•áƒ”áƒ  áƒ¨áƒ”áƒ•áƒ˜áƒœáƒáƒ®áƒ”áƒ—");
            }
            showToast("áƒáƒœáƒ’áƒáƒ áƒ˜áƒ¨áƒ˜ áƒ¨áƒ”áƒœáƒáƒ®áƒ£áƒšáƒ˜áƒ", "ok");
            form.reset();
            loadUsers();
          } catch (err) {
            showToast(err.message || "áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ", "error");
          }
        });

      document
        .getElementById("usersTableBody")
        .addEventListener("click", async (event) => {
          if (!event.target.classList.contains("revoke")) return;
          const su = event.target.dataset.su;
          if (!su) return;

          if (!confirm(`áƒ“áƒáƒ áƒ¬áƒ›áƒ£áƒœáƒ”áƒ‘áƒ£áƒšáƒ˜ áƒ®áƒáƒ áƒ—, áƒ áƒáƒ› áƒ’áƒáƒ—áƒ˜áƒ¨áƒáƒ•áƒ— ${su}?`)) return;

          try {
            const res = await authorizedFetch("/admin/revokeUser", {
              method: "POST",
              body: JSON.stringify({ su }),
            });
            const payload = await res.json();
            if (!payload.success) {
              throw new Error(payload.message || "áƒ•áƒ”áƒ  áƒ’áƒáƒ•áƒ—áƒ˜áƒ¨áƒ”áƒ—");
            }
            showToast("áƒáƒœáƒ’áƒáƒ áƒ˜áƒ¨áƒ˜ áƒ’áƒáƒ—áƒ˜áƒ¨áƒ£áƒšáƒ˜áƒ", "warn");
            loadUsers();
          } catch (err) {
            showToast(err.message || "áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ", "error");
          }
        });

      document
        .getElementById("refreshUsers")
        .addEventListener("click", loadUsers);

      window.addEventListener("DOMContentLoaded", () => {
        const saved = sessionStorage.getItem("adminKey");
        if (saved) {
          state.adminKey = saved;
          document.getElementById("adminKey").value = saved;
          setCardVisibility(true);
          loadUsers();
        }
      });
    </script>
  </body>
</html>
